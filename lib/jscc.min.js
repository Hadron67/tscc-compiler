!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.jscc={})}(this,function(t){"use strict";var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};function n(t,n){e(t,n);function r(){this.constructor=t}t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}var r=32,i=function(){function t(t){this._size=t,this._s=new Array(Math.ceil(t/r));for(var e=0;e<this._s.length;e++)this._s[e]=0}return t.prototype.add=function(t){var e=Math.floor(t/r),n=t-e*r,i=this._s[e];return this._s[e]|=1<<n,i!==this._s[e]},t.prototype.addAll=function(){for(var t=0;t<this._s.length;t++)this._s[t]=-1},t.prototype.remove=function(t){var e=Math.floor(t/r),n=t-e*r,i=this._s[e];return this._s[e]&=~(1<<n),i!==this._s[e]},t.prototype.removeAll=function(){for(var t=0;t<this._s.length;t++)this._s[t]=0},t.prototype.contains=function(t){var e=Math.floor(t/r),n=t-e*r;return 0!=(this._s[e]&1<<n)},t.prototype.union=function(t,e){for(var n=!1,r=0;r<this._s.length;r++){var i=this._s[r],s=t._s[r];e&&(s&=e._s[r]),this._s[r]|=s,n=this._s[r]!==i||n}return n},t.prototype.hasIntersection=function(t){for(var e=0;e<this._s.length;e++)if(0!=(this._s[e]&t._s[e]))return!0;return!1},t.prototype.equals=function(t){for(var e=0;e<this._s.length;e++)if(this._s[e]!==t._s[e])return!1;return!0},t.prototype.forEach=function(t){for(var e=0;e<this._size;e++)this.contains(e)&&t(e)},t.prototype.hash=function(){for(var t="",e=0;e<this._s.length;e++)t+=this._s[e].toString(16)+"-";return t},t}(),s="    ",o={assert:function(t){if(!t)throw new Error("Assertion failed")},log:function(t){}};function a(t,e){return t===h.oo&&e!==h.oo||t!==h._oo&&e===h._oo||t>e?1:t===h._oo&&e!==h._oo||t!==h.oo&&e===h.oo||t<e?-1:0}var h;(u=h||(h={})).oo="oo",u._oo="-oo";var u,l=function(){function t(t,e){this.dataSet=null,this.a=t,this.b=e}return t.prototype.insertBefore=function(t,e,n){if(this.parent.isValid(this)&&!this.parent.noMerge&&this.a===e+1)return this.a=t,this;var r=this.parent.createInterval(t,e,n);return r.prev=this.prev,r.next=this,this.prev.next=r,this.prev=r,r},t.prototype.contains=function(t){return a(this.a,t)<=0&&a(this.b,t)>=0},t.prototype.overlaps=function(t,e){return!(a(t,this.b)>0||a(e,this.a)<0)},t.prototype.insertAfter=function(t,e,n){if(this.parent.isValid(this)&&!this.parent.noMerge&&this.b===t-1)return this.b=e,this;var r=this.parent.createInterval(t,e,n);return r.prev=this,r.next=this.next,this.next.prev=r,this.next=r,r},t.prototype.splitLeft=function(t){if(a(t,this.a)>0){var e=this.insertBefore(this.a,t-1);return this.parent.noMerge&&e.dataSet.union(this.dataSet),this.a=t,e}return this},t.prototype.splitRight=function(t){if(a(t,this.b)<0){var e=this.insertAfter(t+1,this.b);return this.parent.noMerge&&e.dataSet.union(this.dataSet),this.b=t,e}return this},t.prototype.remove=function(){return this.prev.next=this.next,this.next.prev=this.prev,this},t.prototype.checkMerge=function(){return this.a!==h._oo&&null!==this.prev.a&&this.a===this.prev.b+1&&(this.a=this.prev.a,this.prev.remove()),this.b!==h.oo&&null!==this.next.a&&this.b===this.next.a-1&&(this.b=this.next.b,this.next.remove()),this},t.prototype.toString=function(t){var e="";function n(t){return t===h.oo?"+oo":t===h._oo?"-oo":t.toString()}var r=(t||n)(this.a),i=(t||n)(this.b);return this.a===this.b?e+=r:(e+=this.a===h._oo?"("+r:"["+r,e+=",",e+=this.b===h.oo?i+")":i+"]"),this.dataSet&&(e+=this.dataSet.toString()),e},t}();function c(t,e){if(a(t,e)>0)throw new Error('illegal argument: "a"('+t+') must be no more than "b"('+e+")")}var f=function(){function t(t){this.head=new l(0,0),this.head.parent=this,this.tail=new l(null,null),this.tail.parent=this,this.head.next=this.tail,this.tail.prev=this.head,this.noMerge=void 0!==t,this.dataSetConstructor=t||null}return t.prototype.isValid=function(t){return t!==this.head&&t!==this.tail},t.prototype.createInterval=function(t,e,n){void 0===n&&(n=null);var r=new l(t,e);return r.parent=this,this.dataSetConstructor&&(r.dataSet=this.dataSetConstructor()),n&&r.dataSet.add(n),r},t.prototype.fitPoint=function(t,e){for(var n=this.head;n!==this.tail;n=n.next)if((n===this.head||a(t,n.b)>0)&&(n.next===this.tail||a(e,n.next.a)<0))return n;return null},t.prototype.overlaped=function(t,e){for(var n=null,r=null,i=this.head.next;i!==this.tail&&!i.overlaps(t,e);i=i.next);if(i===this.tail)return null;for(n=r=i;i!==this.tail&&i.overlaps(t,e);i=i.next)r=i;return[n,r]},t.prototype.add=function(t,e,n){void 0===e&&(e=t);var r=this.noMerge;c(t,e);var i=this.overlaped(t,e);if(null===i)this.fitPoint(t,e).insertAfter(t,e,n);else if(r){i[0].contains(t)?i[0].splitLeft(t):i[0].insertBefore(t,i[0].a-1,n),i[1].contains(e)?i[1].splitRight(e):i[1].insertAfter(i[1].b+1,e,n);for(var s=i[0];s!==i[1];s=s.next)s.dataSet.add(n),s.b+1<s.next.a&&s.insertAfter(s.b+1,s.next.a-1,n);i[1].dataSet.add(n)}else{var o=a(t,i[0].a)<0?t:i[0].a,h=a(e,i[1].b)>0?e:i[1].b;i[0].a=o,i[0].b=h,i[0].next=i[1].next,i[1].next.prev=i[0],i[0].checkMerge()}return this},t.prototype.remove=function(t,e){c(t,e);var n=this.overlaped(t,e);return null!==n&&(n[0].contains(t)&&n[0].splitLeft(t),n[1].contains(e)&&n[1].splitRight(e),n[0].prev.next=n[1].next,n[1].next.prev=n[0].prev),this},t.prototype.removeAll=function(){return this.head.next=this.tail,this.tail.prev=this.head,this},t.prototype.forEach=function(t){for(var e=this.head.next;e!==this.tail;e=e.next)t(e.a,e.b,e);return this},t.prototype.union=function(t){for(var e=t.head.next;e!==t.tail;e=e.next)this.add(e.a,e.b);return this},t.prototype.contains=function(t){for(var e=this.head.next;e!==this.tail;e=e.next)if(e.contains(t))return!0;return!1},t.prototype.toString=function(t){for(var e="",n=!1,r=this.head.next;r!==this.tail;r=r.next)n&&(e+=","),n=!0,e+=r.toString(t);return""===e?"phi":e},t}(),p=h.oo,d=h._oo,v=function(t){n(e,t);function e(e){return t.call(this,e)||this}return e.prototype.addAll=function(){t.prototype.add.call(this,0,h.oo)},e.prototype.toString=function(){return t.prototype.toString.call(this,function(t){return t!==p&&t!==d?t>=32&&t<=126?"'"+String.fromCharCode(t)+"'":"\\x"+t.toString(16):t===p?"oo":"-oo"})},e}(f),_="\n",g=function(){function t(){}return t.prototype.writeln=function(t){t&&this.write(t),this.write(_)},t}(),m=function(t){n(e,t);function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.s="",e}return e.prototype.write=function(t){this.s+=t},e.prototype.reset=function(){this.s=""},e}(g);function k(t){var e=0;return{peek:function(){return t.charAt(e)||null},next:function(){var t=this.peek();return e++,t}}}function S(t){var e=[];return{peek:function(){return e.length>0?e[e.length-1]:t.peek()},next:function(){return e.length>0?e.pop():t.next()},backup:function(t){e.push(t)}}}var y,x=Object.freeze({endl:_,OutputStream:g,StringOS:m,StringIS:k,biss:S});(E=y||(y={}))[E.START=0]="START",E[E.END=1]="END",E[E.NONE=2]="NONE";var E,T=0,A=function(t){n(e,t);function e(){var n=t.call(this,0)||this;return Object.setPrototypeOf(n,e.prototype),n}return e.prototype.add=function(t){for(var e=0;e<this.length;e++){if(t===this[e])return}this.length>T&&(T=this.length),this.push(t)},e.prototype.union=function(t){for(var e=0,n=t;e<n.length;e++){var r=n[e];this.add(r)}},e.prototype.toArray=function(){for(var t=[],e=0;e<this.length;e++){var n=this[e];t.push(n)}return t},e}(Array),b=function(){return function(t,e){this.chars=new v,this.from=t,this.to=e}}(),w=function(){return function(){this.priority=0,this.id=0,this.data=null}}(),R=function(){function t(t){this.valid=!1,this.arcs=[],this.epsilons=[],this.index=0,this.isStart=!1,this.isEnd=!1,this.marker=!1,this.endAction=null,this.endAction=t||null}return t.prototype.findArc=function(t){for(var e=0,n=this.arcs;e<n.length;e++){var r=n[e];if(r.to===t)return r}return null},t.prototype.to=function(t){var e=this.findArc(t);return null===e&&(e=new b(this,t),this.arcs.push(e)),t.valid=!0,e},t.prototype.epsilonTo=function(t){this.epsilons.push(t)},t.prototype.iterator=function(t){void 0===t&&(t=!1);var e=[this],n=[this];return this.marker=!0,function(){if(e.length>0){var r=e.pop();if(!t)for(var i=0,s=r.arcs;i<s.length;i++){var o=s[i].to;o.marker||(e.push(o),n.push(o),o.marker=!0)}for(var a=0,h=r.epsilons;a<h.length;a++){var u=h[a];u.marker||(e.push(u),n.push(u),u.marker=!0)}return r}for(var l=0,c=n;l<c.length;l++){c[l].marker=!1}return null}},t.prototype.forEach=function(t,e){void 0===e&&(e=!1);var n=[this],r=[this];for(this.marker=!0;n.length>0;){var i=n.pop();if(t(i),!e)for(var s=0,o=i.arcs;s<o.length;s++){var a=o[s].to;a.marker||(n.push(a),r.push(a),a.marker=!0)}for(var h=0,u=i.epsilons;h<u.length;h++){var l=u[h];l.marker||(n.push(l),r.push(l),l.marker=!0)}}for(var c=0,f=r;c<f.length;c++){f[c].marker=!1}},t.prototype.number=function(){var t=0;this.forEach(function(e){e.index=t++})},t.prototype.print=function(t,e){void 0===e&&(e=!0);function n(t){var e="";e+="state "+t.index,t.isStart&&(e+="(start)"),t.endAction&&(e+="(end "+t.endAction.id+")"),e+=_;for(var n=0;n<t.arcs.length;n++){var r=t.arcs[n];e+=""+s+r.chars.toString()+" -> state "+r.to.index+_}if(t.epsilons.length>0){e+=s+"epsilon: ";for(n=0;n<t.epsilons.length;n++)n>0&&(e+=","),e+=t.epsilons[n].index.toString();e+=_}return e}e?this.forEach(function(e){t.write(n(e))}):t.write(n(this))},t.prototype.toString=function(t){void 0===t&&(t=!0);var e=new m;return this.print(e,t),e.s},t.prototype.copyEndFrom=function(t){null!==t.endAction&&(null!==this.endAction?this.endAction.priority<t.endAction.priority&&(this.endAction=t.endAction):this.endAction=t.endAction)},t.prototype.removeEpsilons=function(){var t=[this];this.forEach(function(e){e.valid&&t.push(e)});for(var e=0;e<t.length;e++){var n=t[e];n.forEach(function(t){if(t!==n){for(var e=0;e<t.arcs.length;e++){var r=t.arcs[e];n.to(r.to).chars.union(r.chars)}n.copyEndFrom(t)}},!0),n.epsilons.length=0}for(e=0;e<t.length;e++)t[e].index=e},t.prototype.count=function(){var t=0;return this.forEach(function(){t++}),t},t.prototype.size=function(){var t=0;return this.forEach(function(){t++}),t},t.prototype.allChars=function(t){for(var e=0;e<this.arcs.length;e++){var n=this.arcs[e];n.chars.forEach(function(e,r){t.add(e,r,n.to)})}},t.prototype.getState=function(t){for(var e=0;e<this.arcs.length;e++){var n=this.arcs[e];if(n.chars.contains(t))return n.to}return null},t.prototype.hasArc=function(){return this.arcs.length>0},t.prototype.clone=function(){},t.prototype.toDFA=function(){var t={},e=[],n=0,r=this.count(),i=new v(function(){return new A}),s=new C(r,[this]);s.index=n++,e.push(s),t[s.hash()]=s;for(var o=[s];o.length>0;){var a=o.shift();i.removeAll(),a.allChars(i),i.forEach(function(i,s,h){var u=new C(r,h.dataSet.toArray()),l=u.hash();t[l]?u=t[l]:(t[l]=u,o.push(u),u.index=n++,e.push(u)),a.to(u).chars.add(i,s)})}return s.release(),{head:s,states:e}},t}(),C=function(t){n(e,t);function e(e,n){var r=t.call(this)||this;r.isEnd=r.isStart=!1,r.valid=!0,r.states=n,r.stateSet=new i(e);for(var s=0;s<n.length;s++)r.stateSet.add(n[s].index),r.copyEndFrom(n[s]),r.isStart=r.isStart||n[s].isStart;return r}return e.prototype.hash=function(){return this.stateSet.hash()},e.prototype.allChars=function(t){for(var e=0;e<this.states.length;e++)this.states[e].allChars(t)},e.prototype.forEach=function(e){t.prototype.forEach.call(this,e)},e.prototype.release=function(){this.forEach(function(t){t.states.length=0})},e}(R),N=function(){function t(t){this.states=t,this.start=t[0]}return t.prototype.print=function(t){for(var e=0,n=this.states;e<n.length;e++){n[e].print(t,!1),t.writeln()}},t.prototype.toString=function(){for(var t="",e=0;e<this.states.length;e++)t+=this.states[e].toString()+"\n";return t},t.prototype.matcher=function(t){var e,n=S(t),r=[],i=[],s=null,o=n.peek();function a(){null!==s&&r.push(o),i.push(o),n.next(),o=n.peek()}function h(){for(e=s,s=null;r.length>0;)n.backup(r.pop()),i.pop()}var u=this;return function(){o=n.peek(),e=u.start,i.length=0,r.length=0,s=null;for(var t;;)if(null!==e.endAction){if(!e.hasArc())return{matched:i.join(""),action:e.endAction};if(null===(t=null!==o?e.getState(o.charCodeAt(0)):null))return{matched:i.join(""),action:e.endAction};r.length=0,s=e,e=t,a()}else{if(null===(t=null!==o?e.getState(o.charCodeAt(0)):null)){if(null!==s)return h(),{matched:i.join(""),action:e.endAction};if(null===o)return null;throw new Error('unexpected character "'+o+'"')}e=t,a()}}},t}(),I=function(){function t(t,e){void 0===e&&(e="Error"),this.msg=t,this.type=e}return t.prototype.toString=function(t){void 0===t&&(t={});var e=!!t.escape,n=this.type;return t.typeClass&&(n='<span class="'+t.typeClass+'">'+n+"</span>"),n+=": ",n+=e?this.msg.replace(/</g,"&lt").replace(/>/g,"&gt"):this.msg},t}(),O=function(t){n(e,t);function e(e,n){var r=t.call(this,e,"CompilationError")||this;return r.line=n,r}return e.prototype.toString=function(e){return t.prototype.toString.call(this,e)+" (at line "+this.line+")"},e}(I),L=function(t){n(e,t);function e(e){return t.call(this,e,"Warning")||this}return e}(I),D=function(t){n(e,t);function e(e){return t.call(this,e,"PatternException")||this}return e}(I);function B(t,e){var n=[{sptr:0,s:t,name:""}],r=n[0];return{next:function(){r.sptr++,r.sptr>=r.s.length&&(n.length>1&&n.pop(),r=n[n.length-1])},peek:function(){return r.s[r.sptr]||null},pushTo:function(t){var i=e?e[t]:null;if(!i)throw new D('undefined name "'+t+'"');!function(t){for(var e=0;e<n.length;e++)if(n[e].name===t)throw new D('cannot use pattern "'+t+'" which leads to loop reference')}(t),n.push({sptr:0,s:"("+i+")",name:t}),r=n[n.length-1]}}}function M(t,e){void 0===e&&(e={});var n=B(t,e),r=n.peek();function i(){n.next(),r=n.peek()}function s(t){if(null===r)throw new D("unexpected end of string"+(t?", "+t:""))}function o(){return new R}function a(){return null===r}function h(t){if(r!==t)throw new D('unexpected character "'+r+'",expecting "'+t+'"');i()}function u(t){for(var e=l(t);!a()&&"|"===r;){i();var n=o();t.epsilonTo(n),l(n).epsilonTo(e)}return e}function l(t){var e=t;do{e=c(e)}while(!a()&&"|"!==r&&")"!==r);return e}function c(t){var e=o();t.epsilonTo(e);var c=function(t){{if(s(),"("===r){i();var e=u(t);return h(")"),e}if("."===r){i();var e=o();return t.to(e).chars.addAll(),e}if("["===r){i();var c="^"===r;c&&i();var e=o(),d=t.to(e).chars;for(c&&d.addAll();"]"!==r&&!a();)p(d,c);return h("]"),e}if("{"===r){i();for(var v="";"}"!==r;)s(),v+=r,i();return i(),n.pushTo(v),r=n.peek(),l(t)}var e=o();return t.to(e).chars.add(f()),e}}(e);if("*"===r){i(),c.epsilonTo(e);var d=o();return e.epsilonTo(d),d}if("+"===r){i();var v=o();return c.epsilonTo(v),v.epsilonTo(e),v}if("?"===r){i();var _=o();return e.epsilonTo(_),c.epsilonTo(_),_}return c}function f(){if(s(),"\\"===r){i();var t=r.charCodeAt(0);switch(r){case"t":t="\t";case"n":t="\n";case"r":t="\r";case"x":i();for(var e="";null!==r&&/[0-9a-fA-F]/.test(r);)e+=r,i();return parseInt(e,16);default:t=r}return i(),t.charCodeAt(0)}var n=r.charCodeAt(0);return i(),n}function p(t,e){var n=f(),s=n,o=n;if("-"===r&&(i(),(o=f())<s))throw new D('left hand side must be larger than right hand side in wild card character (got "'+s.toString(16)+'" < "'+o.toString(16)+'")');e?t.remove(s,o):t.add(s,o)}var d=o();d.isStart=!0;return{result:d,tail:u(d)}}function U(t){void 0===t&&(t={});var e=[],n=0;var r=new R;return{lexRule:function(i,s,o,a){var h=new w;h.priority=n++,h.id=s,h.data=o||null;var u=a?function(t){var e=0,n=t.charAt(e);function r(){return new R}var i=r();i.isStart=!0;for(var s=i;null!==n;){var o=r();s.to(o).chars.add(n.charCodeAt(0)),s=o,n=t.charAt(++e)||null}return{result:i,tail:s}}(i):M(i,t);u.tail.endAction=h,r.epsilonTo(u.result),e.push(h)},done:function(){r.removeEpsilons();var t=r.toDFA();return new N(t.states)}}}var G,V=Object.freeze({lexer:function(t,e){var n;n="function"!=typeof t?function(){return t.shift()||null}:t;for(var r=U(e),i=n();null!==i;)r.lexRule(i.regexp,i.id,i.data,i.raw),i=n();return r.done()},lexerBuilder:U}),F=function(t){n(e,t);function e(e){return t.call(this,e)||this}return e.prototype.toString=function(t){var e="",n=!0;this.contains(0)&&(e+='""',n=!1);for(var r=0;r<t.tokenCount;r++)this.contains(r+1)&&(n||(e+=","),e+='"'+t.tokens[r].sym+'"',n=!1);return e},e}(i);(P=G||(G={}))[P.UNDEFINED=0]="UNDEFINED",P[P.LEFT=1]="LEFT",P[P.RIGHT=2]="RIGHT",P[P.NON=3]="NON";var P;function K(t){return null===t.alias?"<"+t.sym+">":'"'+t.alias+'"'}var H=function(){function t(t,e,n){this.g=t,this.lhs=e,this.line=n,this.pr=-1,this.rhs=[],this.action=null,this.index=0,this.vars={},this.usedVars={}}return t.prototype.calcPr=function(){if(-1===this.pr)for(var t=this.rhs.length-1;t>=0;t--){var e=this.rhs[t];e>=0&&this.g.tokens[e].assoc!==G.UNDEFINED&&(this.pr=this.g.tokens[e].pr)}},t.prototype.getVarSp=function(t,e){if(1!==this.lhs.parents.length)return this.lhs.parents.length>1?e("LHS of the rule is referenced by more than one rule"):e("this rule is unreachable"),null;for(var n=this.rhs.length,r=this.lhs.parents[0].pos,i=this.lhs.parents[0].rule;;){var s=i.vars[t];if(void 0!==s&&s.val<r)return n+=r-s.val;if(1!==i.lhs.parents.length)return i.lhs.parents.length>1?e('"'+i.lhs.sym+'" is referenced by more than one rule or unreachable'):e("variable is undefined"),null;n+=r,r=i.lhs.parents[0].pos,i=i.lhs.parents[0].rule}},t.prototype.toString=function(t){for(var e=this.index+": "+this.lhs.sym+" =>",n=0;n<this.rhs.length;n++){var r=this.rhs[n];t===n&&(e+=" ."),e+=r>=0?" "+K(this.g.tokens[r]):" "+this.g.nts[-r-1].sym}return t===this.rhs.length&&(e+=" ."),e},t}(),j=function(){function t(){this.tokens=[],this.tokenCount=0,this.nts=[],this.rules=[]}return t.prototype.isToken=function(t){return t>=0},t.prototype.forEachRule=function(t){for(var e=0;e<this.nts.length;e++)for(var n=this.nts[e].rules,r=0;r<n.length;r++)t(e,n[r])},t.prototype.forEachRuleOfNt=function(t,e){for(var n=this.nts[t].rules,r=0;r<n.length&&!e(n[r]);r++);},t.prototype.genFirstSets=function(){var t=!0,e=new F(this.tokens.length);for(e.addAll(),e.remove(0);t;){t=!1;for(var n=0;n<this.nts.length;n++)for(var r=this.nts[n].rules,i=this.nts[n].firstSet,s=0;s<r.length;s++){for(var o=r[s],a=0;a<o.rhs.length;a++){var h=o.rhs[a];if(this.isToken(h)){t=i.add(h+1)||t;break}if(n!==(h=-h-1)&&(t=i.union(this.nts[h].firstSet,e)||t),!this.nts[h].firstSet.contains(0))break}a===o.rhs.length&&(t=i.add(0)||t)}}},t.prototype.toString=function(t){void 0===t&&(t={});var e=(t=t||{}).endl||e,n=t.escape||!1,r="";if(this.forEachRule(function(t,n){var i=n.toString();r+=i+e}),t.firstSets)for(var i=0;i<this.nts.length;i++){var s=this.nts[i];r+="First("+s.sym+") = { "+s.firstSet.toString(this)+" }"+e}return n&&(r=r.replace(/</g,"&lt;").replace(/>/g,"&gt;")),r.replace(/\n/g,e)},t.prototype.findTokenByName=function(t){for(var e=0,n=this.tokens;e<n.length;e++){var r=n[e];if(r.sym===t)return r}return null},t.prototype.findTokensByAlias=function(t){for(var e=[],n=0,r=this.tokens;n<r.length;n++){var i=r[n];i.alias===t&&e.push(i)}return e},t}(),z=function(){return function(){this.grammar=null,this.lexDFA=[],this.opt={},this.header="",this.extraArgs=""}}(),W=function(){function t(t){this.getRes=t,this._blocked={}}return t.prototype.wait=function(t,e){var n=this.getRes(t);void 0===n?(this._blocked[t]||(this._blocked[t]=[]),this._blocked[t].push(e)):e(!0,n)},t.prototype.signal=function(t,e){var n=this._blocked[t];if(void 0!==n){for(var r=0,i=n;r<i.length;r++){(0,i[r])(!0,e)}delete this._blocked[t]}},t.prototype.fail=function(){for(var t in this._blocked)for(var e=0,n=this._blocked[t];e<n.length;e++){(0,n[e])(!1,null)}},t}(),$=function(){return function(t){this.label=t,this.opcodes=[]}}(),q=function(){function t(t){this.ctx=t,this._head=new R,this._currentState=null,this._unionStack=[],this._simpleStack=[],this._currentArc=null,this._isInverse=!1,this.possibleAlias=null,this._first=!1,this._scount=0,this._regexpVars={},this._states=[new $("")],this._stateMap={DEFAULT:0},this._selectedStates=[],this._selectedVar=null,this._ar=[];var e=this;this.requiringState=new W(function(t){return e._stateMap[t]})}return t.prototype._emit=function(t){if(null!==this._selectedVar)this._selectedVar.opcodes.push(t);else for(var e=0,n=this._selectedStates;e<n.length;e++){n[e].opcodes.push(t)}},t.prototype._exec=function(t){for(this._head=this._currentState=new R,this._head.isStart=!0,this._unionStack.length=0,this._simpleStack.length=0,this._currentArc=null,this._isInverse=!1,this._ar.length=0,this._ar.push({pc:0,cmds:t});this._ar.length>0;){var e=this._ar[this._ar.length-1];e.cmds.opcodes[e.pc++](this),(e=this._ar[this._ar.length-1]).pc>=e.cmds.opcodes.length&&this._ar.pop()}this._head.removeEpsilons();var n=this._head.toDFA();return new N(n.states)},t.prototype.prepareVar=function(t,e){var n=this._regexpVars[t];void 0!==n&&this.ctx.err(new O('variable "'+t+'" was already defined at line '+n.line,e)),n=this._regexpVars[t]={line:e,cmds:new $(t)},this._selectedVar=n.cmds},t.prototype.endVar=function(){this._selectedVar=null},t.prototype.prepareLex=function(){this._selectedStates.length=0},t.prototype.selectState=function(t){var e=this._stateMap[t];void 0===e&&(e=this._stateMap[t]=this._states.length,this._states.push(new $("")),this.requiringState.signal(t,e)),this._selectedStates.push(this._states[this._stateMap[t]])},t.prototype.newState=function(){this._first=!0,this.possibleAlias=null,this._emit(function(t){t._currentState=new R,t._head.epsilonTo(t._currentState)})},t.prototype.end=function(t,e){void 0===e&&(e="(untitled)");for(var n=0,r=this._selectedStates;n<r.length;n++){r[n].label="<"+e+">"}this._emit(function(e){var n=new w;n.id=n.priority=e._scount++,n.data=t,e._currentState.endAction=n})},t.prototype.enterUnion=function(){this._emit(function(t){t._unionStack.push({head:t._currentState,tail:new R})})},t.prototype.endUnionItem=function(){this._emit(function(t){var e=t._unionStack[t._unionStack.length-1];t._currentState.epsilonTo(e.tail),t._currentState=e.head})},t.prototype.leaveUnion=function(){this._emit(function(t){t._currentState=t._unionStack.pop().tail})},t.prototype.enterSimple=function(){this._emit(function(t){t._simpleStack.push(t._currentState)})},t.prototype.simplePostfix=function(t){""===t||(this.possibleAlias=null,this._first=!1),this._emit(function(e){var n=e._simpleStack.pop();"?"===t?n.epsilonTo(e._currentState):"+"===t?e._currentState.epsilonTo(n):"*"===t&&(e._currentState.epsilonTo(n),e._currentState=n)})},t.prototype.addString=function(t){this._first?(this.possibleAlias=t,this._first=!1):this.possibleAlias=null,this._emit(function(e){for(var n=0;n<t.length;n++){var r=new R;e._currentState.to(r).chars.add(t.charCodeAt(n)),e._currentState=r}})},t.prototype.addVar=function(t,e){this._first=!1,this.possibleAlias=null,this._emit(function(n){var r=n._regexpVars[t];void 0===r&&n.ctx.err(new O('use of undefined variable "'+t+'"',e));for(var i=r.cmds,s=0;s<n._ar.length;s++){if(n._ar[s].cmds===i){var o="circular dependence in lexical variable detected: "+i.label;for(s++;s<n._ar.length;s++)o+=" -> "+n._ar[s].cmds.label;return o+=" -> "+i.label,void n.ctx.err(new O(o,e))}}n._ar.push({pc:0,cmds:i})})},t.prototype.beginSet=function(t){this._first=!1,this.possibleAlias=null,this._emit(function(e){e._isInverse=t;var n=new R;e._currentArc=e._currentState.to(n),e._currentState=n,t&&e._currentArc.chars.addAll()})},t.prototype.addSetItem=function(t,e,n,r){1===t.length?1===e.length?(t.charCodeAt(0)>e.charCodeAt(0)&&this.ctx.err(new O("left hand side must be larger than right hand side in wild card character (got '"+t+"' > '"+e+"')",n)),this._emit(function(n){n._isInverse?n._currentArc.chars.remove(t.charCodeAt(0),e.charCodeAt(0)):n._currentArc.chars.add(t.charCodeAt(0),e.charCodeAt(0))})):this.ctx.err(new O('character expected in union, got "'+e+'"',r)):this.ctx.err(new O('character expected in union, got "'+t+'"',n))},t.prototype.endSet=function(){this._emit(function(t){t._currentArc=null})},t.prototype.build=function(){for(var t=[],e=0,n=this._states;e<n.length;e++){var r=n[e];t.push(this._exec(r))}return this.requiringState.fail(),t},t}();function Q(t){}function Y(t){return{toCode:function(e){e.pushLexState(t)},token:-1}}function X(t,e){return{toCode:function(n){n.addBlock(t,e)},token:-1}}var Z;(J=Z||(Z={}))[J.TOKEN=0]="TOKEN",J[J.STRING=1]="STRING",J[J.NAME=2]="NAME";var J,tt,et=function(){function t(t){this._ctx=null,this._f=new z,this._g=new j,this._tokenNameTable={},this._tokenAliasTable={},this._ruleStack=[],this._sematicVar=null,this._ntTable={},this._requiringNt=null,this._genIndex=0,this._first=!0,this._pr=1,this._onCommit=[],this._onDone=[],this._pseudoTokens={};var e=this;this._f.grammar=this._g,this._ctx=t,this.lexBuilder=new q(t),this._requiringNt=new W(function(t){return e._ntTable[t]}),this.defToken("EOF",null,0)}return t.prototype._top=function(){return this._ruleStack[this._ruleStack.length-1]},t.prototype._splitAction=function(t){var e=this._sematicVar;this._sematicVar=null;var n=this._top(),r="@"+this._genIndex++;this.prepareRule(r,t);var i=this._top();this.addAction(n.action),this.commitRule(),n.action=null,this.addRuleItem(r,Z.NAME,t),this._sematicVar=e;for(var s in n.vars){var o=n.vars[s];i.usedVars[s]={val:o.val,line:o.line}}for(var s in n.usedVars){o=n.usedVars[s];i.usedVars[s]={val:o.val,line:o.line}}},t.prototype.err=function(t,e){this._ctx.err(new O(t,e))},t.prototype.defToken=function(t,e,n){var r=this._tokenNameTable[t];return void 0!==r?r:(r={index:this._g.tokens.length,sym:t,alias:e,line:n,pr:0,assoc:G.UNDEFINED,used:!1},null!==e&&(this._tokenAliasTable[e]||(this._tokenAliasTable[e]=[]),this._tokenAliasTable[e].push(r)),this._tokenNameTable[t]=r,this._g.tokens.push(r),r)},t.prototype.getTokenByAlias=function(t,e){var n=this._tokenAliasTable[t];if(void 0===n)return this.err('cannot identify "'+t+'" as a token',e),null;if(n.length>1){for(var r="",i=0;i<n.length;i++)i>0&&(r+=","),r+="<"+n[i].sym+">";return this.err("cannot identify "+t+" as a token, since it could be "+r,e),null}return n[0]},t.prototype.getTokenByName=function(t,e){var n=this._tokenNameTable[t];return void 0===n?(this.err("cannot identify <"+t+"> as a token",e),null):n},t.prototype.defineTokenPrec=function(t,e,n,r){if(n===Z.TOKEN){null!==(i=this.getTokenByName(t,r))&&(i.assoc=e,i.pr=this._pr)}else if(n===Z.STRING){var i;null!==(i=this.getTokenByAlias(t,r))&&(i.assoc=e,i.pr=this._pr)}else if(n===Z.NAME)this._pseudoTokens[t]=this._pseudoTokens[t]||{assoc:e,pr:this._pr,line:r}},t.prototype.setOpt=function(t,e){return this._f.opt[t]=e,this},t.prototype.setHeader=function(t){this._f.header=t},t.prototype.setExtraArg=function(t){this._f.extraArgs=t},t.prototype.setType=function(t){this._f.sematicType=t},t.prototype.incPr=function(){return this._pr++,this},t.prototype.prepareRule=function(t,e){this._first&&(this._first=!1,this.prepareRule("(accept)",e),this.addRuleItem(t,Z.NAME,e),this.addRuleItem("EOF",Z.TOKEN,e),this.commitRule());var n=this._ntTable[t];void 0===n&&(n=this._ntTable[t]={index:this._g.nts.length,sym:t,firstSet:null,used:!1,rules:[],parents:[]},this._g.nts.push(n),this._requiringNt.signal(t,n));var r=new H(this._g,n,e);return this._ruleStack.push(r),this},t.prototype.addRuleUseVar=function(t,e){var n=this._top();void 0!==n.usedVars[t]?this.err('re-use of sematic variable "'+t+'"',e):n.usedVars[t]={line:e,val:0}},t.prototype.addRuleSematicVar=function(t,e){var n=this._top();void 0!==n.usedVars[t]?this.err('variable "'+t+'" conflicts with imported variable defined at line '+n.usedVars[t].line,e):void 0!==n.vars[t]?this.err('sematic variable "'+t+'" is already defined at line '+n.vars[t].line,e):this._sematicVar={line:e,val:t}},t.prototype.addRuleItem=function(t,e,n){var r=this._top();if(null!==r.action&&this._splitAction(n),null!==this._sematicVar&&(r.vars[this._sematicVar.val]={val:r.rhs.length,line:this._sematicVar.line},this._sematicVar=null),e===Z.NAME){var i=this,s=r.rhs.length;r.rhs.push(0),this._requiringNt.wait(t,function(e,o){e?(r.rhs[s]=-o.index-1,o.parents.push({rule:r,pos:s}),o.used=!0):i.err("use of undefined non terminal "+t,n)})}else if(e===Z.TOKEN){var o=this._tokenNameTable[t];if(void 0===o)return void this.err("cannot recognize <"+t+"> as a token",n);r.rhs.push(o.index),o.used=!0}else if(e===Z.STRING){var a=this.getTokenByAlias(t,n);null!==a&&(r.rhs.push(a.index),a.used=!0)}},t.prototype.addAction=function(t){var e=this._top();return null!==e.action&&this._splitAction(e.line),e.action=t,null!==this._sematicVar&&(e.vars[this._sematicVar.val]={val:e.rhs.length,line:this._sematicVar.line},this._sematicVar=null,this._splitAction(e.line)),this},t.prototype.defineRulePr=function(t,e,n){if(e===Z.STRING||e===Z.TOKEN){var r=e===Z.STRING?this.getTokenByAlias(t,n):this.getTokenByName(t,n);if(null!==r){if(r.assoc===G.UNDEFINED)return void this.err('precedence of token "'+t+'" has not been defined',n);this._top().pr=r.pr}}else{var i=this._pseudoTokens[t];i||this.err('pseudo token "'+t+'" is not defined',n),this._top().pr=i.pr}},t.prototype.commitRule=function(){var t=this._ruleStack.pop();t.index=this._g.rules.length,t.lhs.rules.push(t),this._g.rules.push(t);for(var e=0,n=this._onCommit;e<n.length;e++){(0,n[e])()}return this._onCommit.length=0,this},t.prototype.addPushStateAction=function(t,e,n){var r=this;this.lexBuilder.requiringState.wait(e,function(i,s){i?t.push(Y(s)):r._ctx.err(new O('state "'+e+'" is undefined',n))})},t.prototype.build=function(){this._g.tokenCount=this._g.tokens.length,this._g.tokens[0].used=!0,this._g.nts[0].used=!0;for(var t=this,e=0,n=this._g.nts;e<n.length;e++){var r=n[e];r.firstSet=new F(this._g.tokenCount);for(var i=0,s=r.rules;i<s.length;i++){var o=s[i];o.calcPr();var a=function(e){var n=o.usedVars[e];n.val=o.getVarSp(e,function(r){t.err('cannot find variable "'+e+'": '+r,n.line)})};for(var h in o.usedVars)a(h)}}this._f.lexDFA=this.lexBuilder.build();for(var u=0,l=this._onDone;u<l.length;u++){(0,l[u])()}return this._requiringNt.fail(),this._f},t}();(nt=tt||(tt={}))[nt.EOF=0]="EOF",nt[nt.NAME=1]="NAME",nt[nt.STRING=2]="STRING",nt[nt.OPT=3]="OPT",nt[nt.BLOCK=4]="BLOCK",nt[nt.ARROW=5]="ARROW",nt[nt.EOL=6]="EOL",nt[nt.OR=7]="OR",nt[nt.SEPERATOR=8]="SEPERATOR",nt[nt.LEFT_DIR=9]="LEFT_DIR",nt[nt.RIGHT_DIR=10]="RIGHT_DIR",nt[nt.NONASSOC_DIR=11]="NONASSOC_DIR",nt[nt.LEX_DIR=12]="LEX_DIR",nt[nt.PREC_DIR=13]="PREC_DIR",nt[nt.USE_DIR=14]="USE_DIR",nt[nt.HEADER_DIR=15]="HEADER_DIR",nt[nt.EXTRA_ARG_DIR=16]="EXTRA_ARG_DIR",nt[nt.TYPE_DIR=17]="TYPE_DIR",nt[nt.INIT_DIR=18]="INIT_DIR",nt[nt.LINE_COMMENT=19]="LINE_COMMENT",nt[nt.BLOCK_COMMENT=20]="BLOCK_COMMENT",nt[nt.GT=21]="GT",nt[nt.LT=22]="LT",nt[nt.DASH=23]="DASH",nt[nt.BRA=24]="BRA",nt[nt.KET=25]="KET",nt[nt.CBRA=26]="CBRA",nt[nt.CKET=27]="CKET",nt[nt.COMMA=28]="COMMA",nt[nt.PLUS=29]="PLUS",nt[nt.EQU=30]="EQU",nt[nt.STAR=31]="STAR",nt[nt.QUESTION=32]="QUESTION",nt[nt.WEDGE=33]="WEDGE",nt[nt.OPEN_CURLY_BRA=34]="OPEN_CURLY_BRA",nt[nt.CLOSE_CURLY_BRA=35]="CLOSE_CURLY_BRA";var nt,rt=function(){function t(){this.val=null}return t.prototype.clone=function(){var e=new t;return e.id=this.id,e.line=this.line,e.val=this.val,e},t}();function it(t){void 0===t&&(t={});var e=!!t.isHighlight,n=1,r=null,i=null;function s(){return null===i}function o(){"\n"===i&&n++,r.next(),i=r.peek()}function a(t){var e="";throw e=s()?"unexpected end of file":'unexpected character "'+i+'"',new O(t?e+' after "'+t+'"':e,n)}function h(t){for(var e=0;e<t.length;){if(t.charAt(e++)!==i)return!1;o()}return!0}var u={n:"\n",t:"\t",r:"\r"};function l(t){var e=i;if(s())return"";o();var n=u[e];return void 0!==n?n:t?"\\"+e:"\\"===e?"\\":"\\"+e}return{next:function(t){for(t.val=null;r=i,(" "==r||"\n"==r||"\t"==r)&&!s();)o();var r;if(t.line=n,s())return t.id=tt.EOF,t;t:switch(i){case"%":if(o(),h("opt")){t.id=tt.OPT;break t}if(h("le")){if(h("ft")){t.id=tt.LEFT_DIR;break t}if(h("x")){t.id=tt.LEX_DIR;break t}}else{if(h("right")){t.id=tt.RIGHT_DIR;break t}if(h("nonassoc")){t.id=tt.NONASSOC_DIR;break t}if(h("prec")){t.id=tt.PREC_DIR;break t}if(h("use")){t.id=tt.USE_DIR;break t}if(h("header")){t.id=tt.HEADER_DIR;break t}if(h("extra_arg")){t.id=tt.EXTRA_ARG_DIR;break t}if(h("init")){t.id=tt.INIT_DIR;break t}if(h("type")){t.id=tt.TYPE_DIR;break t}if("%"==i){o(),t.id=tt.SEPERATOR;break t}}a("%");case"{":if(o(),e){t.id=tt.OPEN_CURLY_BRA;break t}t.id=tt.BLOCK,t.val="";for(var u=1;u>0;){if(s())throw new O("unclosed block",n);"{"==i?(u++,t.val+=i):"}"==i?--u>0&&(t.val+=i):t.val+=i,o()}break t;case"/":if(o(),"/"===i){for(o(),t.val="//";"\n"!==i&&!s();)t.val+=i,o();t.id=tt.LINE_COMMENT;break t}if("*"===i){for(o(),t.val="/*";!s();)if("*"===i){if(o(),"/"===i){o();break}if(s())break;t.val+="*"}else t.val+=i,o();t.id=tt.BLOCK_COMMENT;break t}a("/");case"|":o(),t.id=tt.OR;break t;case";":o(),t.id=tt.EOL;break t;case":":o(),t.id=tt.ARROW;break t;case"=":o(),t.id=tt.EQU;break t;case"-":if(o(),">"==i){o(),t.id=tt.ARROW;break t}t.id=tt.DASH;break t;case"'":case'"':t.id=tt.STRING,t.val=function(){var t=i,e="";for(o();i!=t;){if(s())throw new O("unterminated string literal",n);"\\"===i?(o(),e+=l(!1)):(e+=i,o())}return o(),e}();break t;case"<":o(),t.id=tt.LT;break t;case">":o(),t.id=tt.GT;break t;case",":o(),t.id=tt.COMMA;break t;case"+":o(),t.id=tt.PLUS;break t;case"?":o(),t.id=tt.QUESTION;break t;case"*":o(),t.id=tt.STAR;break t;case"[":o(),t.id=tt.CBRA;break t;case"]":o(),t.id=tt.CKET;break t;case"(":o(),t.id=tt.BRA;break t;case")":o(),t.id=tt.KET;break t;case"^":o(),t.id=tt.WEDGE;break t;default:if(/[A-Za-z_$]/.test(i)){for(t.id=tt.NAME,t.val=i,o();/[A-Za-z0-9_$]/.test(i)&&!s();)t.val+=i,o();break t}o(),a()}},init:function(t){r=t,i=t.peek()}}}function st(t,e){var n=new rt,r=new et(e);function i(){t.next(n)}function s(t){if(n.id!==t)throw new O('unexpected token "'+tt[n.id]+'", expecting "'+tt[t]+'"',n.line);i()}function o(t,e){var r=n.val,i=n.line;s(t),e(r,i)}function a(t){do{if(n.id===tt.STRING)r.defineTokenPrec(n.val,t,Z.STRING,n.line);else if(n.id===tt.NAME)r.defineTokenPrec(n.val,t,Z.NAME,n.line);else{if(n.id!==tt.LT)throw new O('unexpected token "'+tt[n.id]+'", expecting string or name or "<"',n.line);i();var e=n.val,o=n.line;s(tt.NAME),s(tt.GT),r.defineTokenPrec(e,t,Z.TOKEN,o)}i()}while(n.id===tt.STRING||n.id===tt.NAME||n.id===tt.LT);r.incPr()}function h(){for(r.lexBuilder.prepareLex(),n.id===tt.LT?(i(),function(){var t=n.val;s(tt.NAME),r.lexBuilder.selectState(t);for(;n.id===tt.COMMA;)i(),t=n.val,s(tt.NAME),r.lexBuilder.selectState(t)}(),s(tt.GT)):r.lexBuilder.selectState("DEFAULT"),s(tt.CBRA);n.id!==tt.CKET;)u();s(tt.CKET)}function u(){if(n.id+0===tt.NAME){var t=n.val,e=n.line;i(),s(tt.EQU),s(tt.LT),r.lexBuilder.prepareVar(t,e),f(),r.lexBuilder.endVar(),s(tt.GT)}else if(n.id+0===tt.LT){i(),r.lexBuilder.newState();var o="untitled",a=[];if(n.id===tt.NAME){var h=n.val,u=n.line;o=h,i(),s(tt.ARROW),f();var c=r.defToken(h,r.lexBuilder.possibleAlias,u);a.push({toCode:Q,token:c.index})}else f();s(tt.GT),n.id===tt.ARROW&&(i(),l(a)),r.lexBuilder.end(a,o)}}function l(t){if(n.id===tt.CBRA){for(n.id+=0,i(),c(t);n.id===tt.COMMA;)i(),c(t);s(tt.CKET)}else{if(n.id!==tt.BLOCK)throw new O('unexpected token "'+tt[n.id]+'"',n.line);t.push(X(n.val,n.line)),i()}}function c(t){if(n.id===tt.PLUS){i();var o=n.val,a=n.line;s(tt.NAME),r.lexBuilder.requiringState.wait(o,function(n,r){n?t.push(Y(r)):e.err(new O('state "'+o+'" is undefined',a))})}else if(n.id===tt.DASH)i(),t.push({toCode:function(t){t.popLexState()},token:-1});else if(n.id===tt.BLOCK)i(),t.push(X(n.val,n.line));else{if(n.id!==tt.EQU)throw new O('unexpected token "'+tt[n.id]+'"',n.line);i();var h=n.val;s(tt.STRING),t.push((u=h,{toCode:function(t){t.setImg(u)},token:-1}))}var u}function f(){for(r.lexBuilder.enterUnion(),p(),r.lexBuilder.endUnionItem();n.id===tt.OR;)i(),p(),r.lexBuilder.endUnionItem();r.lexBuilder.leaveUnion()}function p(){do{d()}while(n.id!==tt.GT&&n.id!==tt.OR&&n.id!==tt.KET)}function d(){switch(r.lexBuilder.enterSimple(),function(){if(n.id===tt.BRA)i(),f(),s(tt.KET);else if(n.id===tt.CBRA)i(),function(){n.id===tt.WEDGE?(i(),r.lexBuilder.beginSet(!0)):r.lexBuilder.beginSet(!1);if(n.id!==tt.CKET)for(v();n.id===tt.COMMA;)i(),v()}(),s(tt.CKET);else if(n.id===tt.STRING){var t=n.val;i(),r.lexBuilder.addString(t)}else{if(n.id!==tt.LT)throw new O('unexpected token "'+tt[n.id]+'"',n.line);i();var e=n.val,o=n.line;s(tt.NAME),s(tt.GT),r.lexBuilder.addVar(e,o)}}(),n.id){case tt.PLUS:i(),r.lexBuilder.simplePostfix("+");break;case tt.STAR:i(),r.lexBuilder.simplePostfix("*");break;case tt.QUESTION:i(),r.lexBuilder.simplePostfix("?");break;default:r.lexBuilder.simplePostfix("")}}function v(){var t=n.val,e=n.line,o=t,a=e;s(tt.STRING),n.id===tt.DASH&&(i(),o=n.val,a=n.line,s(tt.STRING)),r.lexBuilder.addSetItem(t,o,e,a)}function _(){var t=n.clone();for(s(tt.NAME),s(tt.ARROW),r.prepareRule(t.val,t.line),g(),r.commitRule();n.id===tt.OR;)i(),r.prepareRule(t.val,t.line),g(),r.commitRule();s(tt.EOL)}function g(){for(n.id===tt.USE_DIR&&(i(),s(tt.BRA),function(){var t=n.val,e=n.line;s(tt.NAME),r.addRuleUseVar(t,e);for(;n.id===tt.COMMA;)i(),t=n.val,e=n.line,s(tt.NAME),r.addRuleUseVar(t,e)}(),s(tt.KET));n.id===tt.NAME||n.id===tt.LT||n.id===tt.STRING||n.id===tt.BLOCK||n.id===tt.CBRA;)m();if(n.id===tt.PREC_DIR){i();var t=n.val,e=n.line;if(n.id===tt.STRING)r.defineRulePr(t,Z.STRING,e),i();else if(n.id===tt.LT)i(),t=n.val,e=n.line,s(tt.NAME),s(tt.GT),r.defineRulePr(t,Z.TOKEN,e);else{if(n.id!==tt.NAME)throw new O('unexpected token "'+tt[n.id]+'",expecting string or name',n.line);r.defineRulePr(t,Z.NAME,e),i()}if(n.id===tt.BLOCK||n.id===tt.CBRA){var o=[];l(o),r.addAction(o)}}}function m(){var t=n.clone();if(n.id===tt.NAME){if(i(),n.id!==tt.EQU)return void r.addRuleItem(t.val,Z.NAME,t.line);i(),r.addRuleSematicVar(t.val,t.line),t=n.clone()}if(n.id===tt.NAME?(i(),r.addRuleItem(t.val,Z.NAME,t.line)):n.id===tt.STRING?(i(),r.addRuleItem(t.val,Z.STRING,t.line)):n.id===tt.LT&&(i(),t=n.clone(),s(tt.NAME),s(tt.GT),r.addRuleItem(t.val,Z.TOKEN,t.line)),n.id===tt.BLOCK||n.id===tt.CBRA){var e=[];l(e),r.addAction(e)}}return i(),function(){for(;;)switch(n.id){case tt.LEFT_DIR:i(),a(G.LEFT);break;case tt.RIGHT_DIR:i(),a(G.RIGHT);break;case tt.NONASSOC_DIR:i(),a(G.NON);break;case tt.OPT:i();var t=n.val;s(tt.NAME);var e=n.val;s(tt.STRING),r.setOpt(t,e);break;case tt.LEX_DIR:i(),h();break;case tt.HEADER_DIR:i(),o(tt.BLOCK,function(t,e){return r.setHeader(t)});break;case tt.EXTRA_ARG_DIR:i(),o(tt.BLOCK,function(t,e){return r.setExtraArg(t)});break;case tt.TYPE_DIR:i();var u=n.val;s(tt.NAME),r.setType(u);break;default:return}}(),s(tt.SEPERATOR),function(){for(_();n.id!==tt.SEPERATOR;)_();i()}(),s(tt.EOF),r.build()}var ot={T:tt,Token:rt,scanner:it};function at(t,e){var n=it();return n.init(t),st((r=n,{next:function(t){do{r.next(t)}while(t.id===tt.BLOCK_COMMENT||t.id===tt.LINE_COMMENT)},init:function(t){r.init(t)}}),e);var r}var ht;(ut=ht||(ht={}))[ut.NONE=1]="NONE",ut[ut.SHIFT=2]="SHIFT",ut[ut.REDUCE=3]="REDUCE";var ut,lt=function(){function t(t,e){this.marker=0,this.shift=null,this.actionType=ht.NONE,this.changed=!0,this.rule=t,this.isKernel=e,this.lah=new F(t.g.tokenCount)}return t.prototype.canShift=function(){return this.rule.rhs.length>this.marker},t.prototype.getShift=function(){return this.rule.rhs[this.marker]},t.prototype.toString=function(t){void 0===t&&(t={});var e=t&&t.showlah||!1,n=t&&t.showTrailer||!1,r="[ "+this.rule.toString(this.marker)+(e?",{ "+this.lah.toString(this.rule.g)+" }":"")+" ]";if(this.isKernel&&(r+="*"),n)switch(this.actionType){case ht.NONE:r+="(-)";break;case ht.SHIFT:r+="(s"+this.shift.stateIndex+")";break;case ht.REDUCE:r+="(r)"}return r},t.prototype.hash=function(){return this.rule.index+"-"+this.marker},t.prototype.hasRRConflictWith=function(t){return this.actionType===ht.REDUCE&&t.actionType===ht.REDUCE&&this.rule.index!==t.rule.index&&this.lah.hasIntersection(t.lah)},t.prototype.getFollowSet=function(t){var e,n=this.rule.g;for(e=this.marker+1;e<this.rule.rhs.length;e++){var r=this.rule.rhs[e];if(n.isToken(r)){t.add(r+1);break}var i=n.nts[-r-1].firstSet;if(t.union(i),t.remove(0),!i.contains(0))break}e===this.rule.rhs.length&&t.union(this.lah)},t.NULL={},t}(),ct=function(){function t(t){this.it={},this.complete=!1,this.index=-1,this.stateIndex=0,this.prev=null,this.next=null,this.merges=[],this.g=t,this.data=this}return t.prototype.add=function(t,e,n,r,i){var s=t.index+"-"+e,o=this.it[s];if(void 0===o){var a=new lt(t,n);return a.marker=e,r&&a.lah.union(r),this.it[s]=a,!0}if(r){var h=o.lah.union(r);return i&&h&&o.canShift()&&(o.actionType=ht.NONE),h&&(o.changed=!0),h}},t.prototype.contains=function(){},t.prototype.closure=function(){for(var t=!0,e=new F(this.g.tokenCount),n=this;t;){t=!1;for(var r in this.it){var i=this.it[r];if(i.changed&&i.canShift()){var s=i.getShift();s<0&&(e.removeAll(),i.getFollowSet(e),this.g.forEachRuleOfNt(-s-1,function(r){return t=n.add(r,0,!1,e,!1)||t,!1}))}i.changed=!1}}},t.prototype.toString=function(t){var e={showTrailer:t&&t.showTrailer||!1},n="s"+this.stateIndex;if(null!==this.index?n+="(i"+this.index:n+="(i?",this.merges.length>0){n+=",merged from ";for(var r=0;r<this.merges.length;r++)r>0&&(n+=","),n+="i"+this.merges[r]}n+=")"+_;for(var i in this.it)n+=this.it[i].toString(e)+_;return n},t.prototype.kernelHash=function(){var t=0;for(var e in this.it){var n=this.it[e];n.isKernel&&(t+=n.rule.index<<5+n.rule.index+n.marker)}return String(t)},t.prototype.forEach=function(t){for(var e in this.it)t(this.it[e])},t.prototype.canMergeTo=function(t){for(var e in this.it){var n=this.it[e],r=!1,i=!1,s=!1;for(var o in t.it){var a=t.it[o];if(n.rule.index===a.rule.index&&n.marker===a.marker&&(s=n.lah.equals(a.lah),r=n.isKernel&&a.isKernel),i=i||n.hasRRConflictWith(a),a.isKernel&&void 0===this.it[o])return!1}if(n.isKernel&&!r||i&&!s)return!1}return!0},t.prototype.mergeTo=function(t){var e=!1;for(var n in t.it){var r=t.it[n];e=this.add(r.rule,r.marker,r.isKernel,r.lah,!0)||e}return this.merges.push(t.index),e},t}(),ft=function(){function t(){this.size=0,this.head={prev:null,next:null,data:null},this.tail={prev:null,next:null,data:null},this.head.next=this.tail,this.tail.prev=this.head}return t.prototype.append=function(t){t.prev=this.tail.prev,t.next=this.tail,this.tail.prev.next=t,this.tail.prev=t,this.size++},t.prototype.pull=function(){var t=this.head.next;return this.head.next=t.next,t.next.prev=this.head,t.prev=t.next=null,this.size--,t.data},t.prototype.isEmpty=function(){return 0===this.size},t.prototype.forEach=function(t){for(var e=this.head.next;e!==this.tail;e=e.next)t(e.data)},t.prototype.remove=function(t){t.next.prev=t.prev,t.prev.next=t.next,this.size--},t.prototype.iterator=function(){var t=this.head,e=this;return function(){return t!==e.tail?(t=t.next).data:null}},t}();var pt,dt=function(){function t(t,e){this.defred=null,this.g=t;var n=t.tokenCount,r=t.nts.length;this.stateCount=e,this.shift=new Array(n*e),this.gotot=new Array(r*e);for(var i=0;i<this.shift.length;i++)this.shift[i]=null;for(i=0;i<this.gotot.length;i++)this.gotot[i]=null}return t.prototype.forEachShift=function(t){for(var e=0;e<this.stateCount;e++)for(var n=0;n<this.g.tokens.length;n++){var r=this.lookupShift(e,n);r&&t(r,e,n)}},t.prototype.forEachGoto=function(t){for(var e=0;e<this.stateCount;e++)for(var n=0;n<this.g.nts.length;n++){var r=this.lookupGoto(e,n);r&&t(r,e,n)}},t.prototype.lookupShift=function(t,e){return this.shift[this.g.tokenCount*t+e]},t.prototype.lookupGoto=function(t,e){return this.gotot[this.g.nts.length*t+e]},t.prototype._getDefRed=function(t,e){for(var n=0;n<e.length;n++)e[n]=0;for(var r=0;r<this.g.tokenCount;r++){var i=this.lookupShift(t,r);i&&i.actionType===ht.REDUCE&&e[i.rule.index]++}var s=0;for(n=0;n<e.length;n++)e[n]>e[s]&&(s=n);return e[s]>0?s:-1},t.prototype.findDefAct=function(){this.defred=new Array(this.stateCount);for(var t=new Array(this.g.rules.length),e=0;e<this.stateCount;e++){var n=this._getDefRed(e,t);if(this.defred[e]=n,-1!==n)for(var r=0;r<this.g.tokens.length;r++){var i=this.lookupShift(e,r);i&&i.actionType===ht.REDUCE&&i.rule.index===n&&(this.shift[this.g.tokenCount*e+r]=null)}}},t}();(vt=pt||(pt={}))[vt.RR=0]="RR",vt[vt.SR=1]="SR";var vt,_t=function(){function t(){}return t.prototype.toString=function(){return"state "+this.set.stateIndex+", "+t.cNames[this.type]+" conflict:"+_+s+"token: "+K(this.token)+_+s+"used rule: "+this.used.toString()+_+s+"discarded rule: "+this.discarded.toString()},t.cNames=["reduce/reduce","shift/reduce"],t}();function gt(t){var e={},n=0;function r(t){var n=t.kernelHash();void 0===e[n]&&(e[n]=[]),e[n].push(t)}function i(t,n){var r=e[t.kernelHash()];if(void 0!==r)for(var i=0;i<r.length&&!n(r[i]);i++);}var s=1,a=new ft,h=new ft,u=new ft;for(a.append(function(t){var e=t.nts[0].rules[0],n=new ct(t);n.index=0;var r=new F(t.tokenCount);return r.add(1),n.add(e,0,!0,r,!1),n}(t));!a.isEmpty()||!h.isEmpty();){var l=null;if(!h.isEmpty()){(c=l=h.pull()).forEach(function(e){if(e.actionType===ht.NONE){o.assert(e.canShift());var n=e.getShift(),r=new ct(t);r.index=s++,a.append(r),c.forEach(function(t){if(t.canShift()){t.getShift()===n&&(t.actionType=ht.SHIFT,t.shift=r,r.add(t.rule,t.marker+1,!0,t.lah,!1))}})}}),c.complete=!0,u.append(c)}for(;!a.isEmpty();){var c;(c=a.pull()).closure(),c.forEach(function(t){t.canShift()||(t.actionType=ht.REDUCE)});var f=null;i(c,function(t){return!!t.canMergeTo(c)&&(t.mergeTo(c)&&t.complete&&(f=t),null!==l&&l.forEach(function(e){e.actionType===ht.SHIFT&&e.shift===c&&(e.shift=t)}),c=null,!0)}),null!==f?(u.remove(f),h.append(f),f.complete=!1):null!==c&&(h.append(c),r(c))}n++}var p=0;return u.forEach(function(t){t.stateIndex=p++}),{result:u,iterations:n}}function mt(t){var e=[];return{add:function(n){var r;for(r=0;r<e.length&&!((0===r||t(n,e[r-1])>=0)&&t(n,e[r])<=0);r++);!function(t,n){e.push(null);for(var r=e.length-1;r>t;r--)e[r]=e[r-1];e[t]=n}(r,n)},done:function(){return e}}}var kt=function(){return function(t,e){this.emptyCount=t,this.row=e,this.dp=0}}();function St(t){function e(e,n){return(n-=o[e].dp)<0||n>=t.columns||t.isEmpty(o[e].row,n)}function n(n,r){for(var i=0;i<t.columns;i++)if(!e(n,i))for(var s=0;s<n;s++)if(!e(s,i+r))return!1;return!0}function r(e){for(var r=0;-r<t.columns&&t.isEmpty(o[e].row,-r);)r--;for(;!n(e,r);)r++;return r}for(var i=mt(function(t,e){return t.emptyCount<e.emptyCount?-1:t.emptyCount>e.emptyCount?1:0}),s=0;s<t.rows;s++)i.add(new kt(t.emptyCount(s),s));for(var o=i.done(),a=0,h=0,u=new Array(t.rows),l=0;-l<t.columns&&t.isEmpty(o[0].row,-l);)l--;u[o[0].row]=o[0].dp=l;for(s=1;s<o.length;s++){var c=o[s].row,f=r(s);u[c]=o[s].dp=f,f>a&&(a=f),f<h&&(h=f)}return{dps:u,len:a+t.columns}}function yt(t,e){for(var n=new Array(t),r=0;r<t;r++)n[r]=e(r);return n}var xt=function(){function t(t){this.g=t.g,this.defred=t.defred,this.stateCount=t.stateCount;var e=St(function(t){for(var e=[],n=0;n<t.stateCount;n++){e.push(0);for(var r=0;r<t.g.tokens.length;r++)null===t.lookupShift(n,r)&&e[n]++}return{rows:t.stateCount,columns:t.g.tokens.length,isEmpty:function(e,n){return null===t.lookupShift(e,n)},emptyCount:function(t){return e[t]}}}(t)),n=St(function(t){for(var e=[],n=0;n<t.stateCount;n++){e.push(0);for(var r=0;r<t.g.nts.length;r++)null===t.lookupShift(n,r)&&e[n]++}return{rows:t.stateCount,columns:t.g.nts.length,isEmpty:function(e,n){return null===t.lookupGoto(e,n)},emptyCount:function(t){return e[t]}}}(t));this.disact=e.dps,this.disgoto=n.dps,this.pact=yt(e.len,function(){return null}),this.checkact=yt(e.len,function(){return 0});var r=this;t.forEachShift(function(t,e,n){o.assert(null===r.pact[r.disact[e]+n]),r.pact[r.disact[e]+n]=t,r.checkact[r.disact[e]+n]=e}),this.pgoto=yt(n.len,function(){return null}),this.checkgoto=yt(n.len,function(){return 0}),t.forEachGoto(function(t,e,n){o.assert(null===r.pgoto[r.disgoto[e]+n]),r.pgoto[r.disgoto[e]+n]=t,r.checkgoto[r.disgoto[e]+n]=e})}return t.prototype.lookupShift=function(t,e){var n=this.disact[t]+e;return n>=0&&n<this.pact.length&&this.checkact[n]===t?this.pact[this.disact[t]+e]:null},t.prototype.lookupGoto=function(t,e){var n=this.disgoto[t]+e;return n>=0&&n<this.pgoto.length&&this.checkgoto[n]===t?this.pgoto[this.disgoto[t]+e]:null},t}(),Et=function(){function t(){this.errors=[],this.warnings=[],this.terminated=!1}return t.prototype.warn=function(t){this.warnings.push(t)},t.prototype.err=function(t){this.errors.push(t)},t.prototype.printItemSets=function(t){t.writeln(this.itemSets.size+" state(s) in total,finished in "+this.iterationCount+" iteration(s)."),this.itemSets.forEach(function(e){t.writeln(e.toString({showTrailer:!0}))})},t.prototype.printTable=function(t){!function(t,e,n){var r=e.g,i=r.tokenCount,o=r.nts.length;n.forEach(function(n){var a=n.stateIndex,h="",u="",l="";t.writeln("state "+a),n.forEach(function(e){t.writeln(s+e.toString({showTrailer:!1}))}),-1!==e.defred[a]?t.writeln(s+"default action: reduce with rule "+e.defred[a]):t.writeln(s+"no default action");for(var c=0;c<i;c++)null!==(f=e.lookupShift(a,c))&&f!==lt.NULL&&(f.actionType===ht.SHIFT?h+=""+s+K(r.tokens[c])+" : shift, and goto state "+f.shift.stateIndex+_:u+=""+s+K(r.tokens[c])+" : reduce with rule "+f.rule.index+_);for(c=0;c<o;c++){var f;null!==(f=e.lookupGoto(a,c))&&(l+=""+s+r.nts[c].sym+" : goto state "+f.shift.stateIndex+_)}t.writeln(h+u+l),t.writeln("")})}(t,this.parseTable,this.itemSets)},t.prototype.printDFA=function(t){for(var e=0,n=this.file.lexDFA;e<n.length;e++){n[e].print(t),t.writeln(),t.writeln()}},t.prototype.testParse=function(t){return function(t,e,n){for(var r=[],i=0,s=n;i<s.length;i++){var o=s[i],a=void 0;if(/<[^>]+>/.test(o)){if(null===(a=t.findTokenByName(o.substr(1,o.length-2))))throw new I("cannot recognize "+o+" as a token")}else{var h=t.findTokensByAlias(o);if(0===h.length)throw new I('cannot recognize "'+o+'" as a token');if(h.length>1){for(var u="",l=0,c=h;l<c.length;l++)u+="<"+c[l].sym+"> ";throw new I('cannot recognize "'+o+'" as a token, since it can be '+u)}a=h[0]}r.push(a)}var f=[0],p=[],d=[];function v(){return f[f.length-1]}function _(t){f.push(t);var e=r.shift();p.push(K(e))}function g(t){f.length-=t.rhs.length,p.length-=t.rhs.length,p.push(t.lhs.sym);var n=e.lookupGoto(v(),t.lhs.index).shift.stateIndex;f.push(n)}function m(){for(var t="",e=0,n=p;e<n.length;e++)t+=n[e]+" ";t+="| ";for(var i=0,s=r;i<s.length;i++)t+=K(s[i]),t+=" ";return t}for(d.push(m());;){var k=e.lookupShift(v(),r[0]?r[0].index:0);if(null!==k){if(k===lt.NULL){d.push("syntax error!");break}if(k.actionType===ht.SHIFT){if(0===r.length){d.push("accepted!");break}_(k.shift.stateIndex)}else if(k.actionType===ht.REDUCE){if(g(k.rule))break}else console.assert(!1)}else{var S=e.defred[v()];if(-1===S){d.push("syntax error!");break}g(t.rules[S])}d.push(m())}return d}(this.file.grammar,this.parseTable,t)},t.prototype.printError=function(t,e){for(var n=0,r=this.errors;n<r.length;n++){var i=r[n];t.writeln(i.toString(e))}t.writeln()},t.prototype.printWarning=function(t,e){for(var n=0,r=this.warnings;n<r.length;n++){var i=r[n];t.writeln(i.toString(e))}t.writeln()},t.prototype.hasWarning=function(){return this.warnings.length>0},t.prototype.hasError=function(){return this.errors.length>0},t.prototype.warningSummary=function(){return this.warnings.length+" warning(s), "+this.errors.length+" error(s)"},t.prototype.getTemplateInput=function(){return{prefix:"jj",endl:"\n",opt:this.file.opt,header:this.file.header,extraArg:this.file.extraArgs,g:this.file.grammar,pt:this.parseTable,sematicType:this.file.sematicType,dfas:this.file.lexDFA}},t}();var Tt={};At=function(t,e){!function(t,e){s("/*"),s("    generated by jscc, an LALR(1) parser generator made by hadroncfy."),s("    template for typescript, written by hadroncfy, aussi."),s("*/"),i(t.header);var n=t.prefix,r=t.opt.tab||"    ";function i(t){e.write(t)}function s(t){e.writeln(t)}function o(t,e){return(t.length<e?function(t,e){for(var n="";e-- >0;)n+=t;return n}(" ",e-t.length):"")+t}function a(e,a,h,u,l){var c=1;s(""),i("let "),i(n+e),s(" = [ "),i(r);for(var f=0,p=a;f<p.length;f++)i(o(l(p[f]),h)),i(","),c++>=u&&(c=1,i(t.endl+r));s(""),i("]; ")}function u(t){function e(t){var e=[];return t.chars.forEach(function(t,n){t===n?e.push("c === "+t):0===t&&n!==h.oo?e.push("c <= "+n):0!==t&&n===h.oo?e.push("c >= "+t):0!==t&&n!==h.oo?e.push("(c >= "+t+" && c <= "+n+")"):e.push("true")}),e.join(" || ")}var n=!0;s(""),i("        case "),i(t.index),s(":"),i("            ret.hasArc = "),i(t.arcs.length>0?"true":"false"),s(";"),i("            ret.isEnd = "),i(null===t.endAction?"false":"true"),i(";");for(var r=0,o=t.arcs;r<o.length;r++){var a=o[r];n?(s(""),i("            if("),i(e(a)),s("){"),i("                ret.state = "),i(a.to.index),s(";"),i("            }"),n=!1):(s(""),i("            else if("),i(e(a)),s("){"),i("                ret.state = "),i(a.to.index),s(";"),i("            }"))}0===t.arcs.length?(s(""),i("            ret.state = -1;")):(s(""),s("            else {"),s("                ret.state = -1;"),i("            }")),s(""),i("            break;")}function l(t,e){s(""),i("function moveDFA"),i(e),s("(c: number, ret: { state: number, hasArc: boolean, isEnd: boolean }){"),i("    switch(ret.state){");for(var n=0,r=t.states;n<r.length;n++)u(r[n]);s(""),s("        default:"),s("            ret.state = -1;"),s("            ret.hasArc = false;"),s("    }"),i("}")}function c(t,e){a("lexTokens"+e,t.states,6,10,function(t){return t.endAction?function(t){for(var e=0,n=t;e<n.length;e++){var r=n[e];if(-1!==r.token)return r.token}return-1}(t.endAction.data).toString():"-1"})}s(""),s(""),s("/*"),s("    find the next state to go in the dfa"),i("*/");for(var f=0,p=t.dfas;f<p.length;f++)l(p[f],f);s(""),s(""),s("/*"),s("    all the lexer data goes here."),s("*/"),i("let "),i(n),i("lexers = [");for(f=0;f<t.dfas.length;f++)s(""),i("    moveDFA"),i(f),i(",");s(""),s("];"),s(""),s("/*"),s("    tokens that a lexical dfa state can return"),i("*/");for(f=0,p=t.dfas;f<p.length;f++)c(p[f],f);s("");var d=t.pt;s(""),i("let "),i(n),i("stateCount = "),i(d.stateCount),s(";"),i("let "),i(n),i("tokenCount = "),i(t.g.tokens.length),s(";"),i("let "),i(n),i("actERR = "),i(d.stateCount+1),s(";"),s("/*"),i("    compressed action table: action = "),i(n),i("pact["),i(n),s("disact[STATE-NUM] + TOKEN]"),s("    when action > 0, shift the token and goto state (action - 1);"),s("    when action < 0, reduce with rule (1-action);"),s("    when action = 0, do default action."),i("*/"),a("pact",d.pact,6,10,function(t){return null===t?"0":t===lt.NULL?String(d.stateCount+1):t.actionType===ht.SHIFT?(t.shift.stateIndex+1).toString():t.actionType===ht.REDUCE?(-t.rule.index-1).toString():void 0}),s(""),s("/*"),s("    displacement of action table."),i("*/"),a("disact",d.disact,6,10,function(t){return t.toString()}),s(""),s("/*"),i("    used to check if a position in "),i(n),s("pact is out of bouds."),i("    if "),i(n),i("checkact["),i(n),s("disact[STATE-NUM] + TOKEN] = STATE-NUM, this position is not out of bounds."),i("*/"),a("checkact",d.checkact,6,10,function(t){return void 0===t?"0":t.toString()}),s(""),s("/*"),i("    default action table. action = "),i(n),s("defred[STATE-NUM],"),s("    where action is the number of the rule to reduce with."),i("*/"),a("defred",d.defred,6,10,function(t){return t.toString()}),s(""),s("/*"),i("    compressed goto table: goto = "),i(n),i("pgoto["),i(n),s("disgoto[STATE-NUM] + NON_TERMINAL]"),i("*/"),a("pgoto",d.pgoto,6,10,function(t){return null===t?"-1":t.shift.stateIndex.toString()}),s(""),s("/*"),s("    displacement of the goto table"),i("*/"),a("disgoto",d.disgoto,6,10,function(t){return t.toString()}),s(""),s("/*"),i("    length of each rule: rule length = "),i(n),s("ruleLen[RULE-NUM]"),i("*/"),a("ruleLen",d.g.rules,6,10,function(t){return t.rhs.length.toString()}),s(""),s("/*"),s("    index of the LHS of each rule"),i("*/"),a("lhs",d.g.rules,6,10,function(t){return t.lhs.index.toString()}),s(""),s("/*"),s("    token names"),i("*/"),a("tokenNames",d.g.tokens,20,3,function(t){return'"'+t.sym+'"'}),s(""),s("/*"),s("    token alias"),i("*/"),a("tokenAlias",d.g.tokens,20,3,function(t){return t.alias?'"'+t.alias+'"':"null"});var v=t.opt.className||"Parser";s("");function _(t,e){var r={addBlock:function(t,e){s(""),i("                "),i(t.replace(/\$token/g,"this._token").replace(/\$\$/g,"this._sematicVal"))},pushLexState:function(t){s(""),i("                this._lexState.push("),i(t),i(");")},popLexState:function(){s(""),i("                this._lexState.pop();")},setImg:function(t){s(""),i('                this._setImg("'),i(t),i('");')},returnToken:function(t){s(""),s("                this._token = {"),i("                    id: "),i(t.index),s(","),s("                    val: this._matched.join('')"),i("                };")}};function o(t){for(var e=0,n=t;e<n.length;e++)if(-1===n[e].token)return!0;return!1}var a=n+"staten";s(""),i("    private _doLexAction"),i(e),i("("),i(a),s(": number){"),i("        let "),i(n),i("tk = "),i(n),i("lexTokens"),i(e),i("["),i(a),s("];"),i("        "),i(n),i("tk !== -1 && this._prepareToken("),i(n),s("tk);"),i("        switch("),i(a),i("){");for(var h=0,u=t.states;h<u.length;h++)if(null!==u[h].endAction&&o(u[h].endAction.data)){s(""),i("            case "),i(h),i(":");for(var l=0,c=u[h].endAction.data;l<c.length;l++){var f=c[l];-1===f.token&&f.toCode(r)}s(""),i("                break;")}s(""),s("            default:;"),s("        }"),i("    }")}s(""),s(""),s("export function tokenToString(tk: number){"),i("    return "),i(n),i("tokenAlias[tk] === null ? `<${"),i(n),i('tokenNames[tk]}>` : `"${'),i(n),s('tokenAlias[tk]}"`;'),s("}"),s(""),s("export class Token {"),s("    constructor("),s("        public id: number,"),s("        public val: string,"),s("        public startLine: number,"),s("        public startColumn: number,"),s("        public endLine: number,"),s("        public endColumn: number"),s("    ){}"),s("    toString(){"),i("        return ("),i(n),s("tokenAlias[this.id] === null ? "),i("            `<${"),i(n),s("tokenNames[this.id]}>` :"),i('            `"${'),i(n),s('tokenAlias[this.id]}"`) + `("${this.val}")`;'),s("    }"),i("}");var g=t.sematicType||"any";s(""),i("export class "),i(v),s(" {"),s("    // members for lexer"),s("    private _lexState: number[];"),s("    private _state: number;"),s("    private _matched: string[];"),s("    private _token: Token;"),s("    private _marker: number;"),s("    private _markerLine;"),s("    private _markerColumn;"),s("    private _backupCount: number;"),s("    private _inputBuf: string[];"),s("    private _line: number;"),s("    private _column: number;"),s("    private _tline: number;"),s("    private _tcolumn: number;"),s(""),s("    // members for parser"),s("    private _lrState: number[] = [];"),i("    private _sematicS: "),i(g),s("[] = [];"),i("    private _sematicVal: "),i(g),s(";"),s(""),s("    private _stop;"),s(""),s("    private _handlers: {[s: string]: ((a1?, a2?, a3?) => any)[]} = {};"),s(""),s("    // extra members, defined by %extra_arg"),i("    "),i(t.extraArg),s(""),s(""),s("    constructor(){"),s("        this.init();"),s("    }"),s("    init(){"),s("        this._lexState = [ 0 ];// DEFAULT"),s("        this._state = 0;"),s("        this._matched = [];"),s("        this._token = null;"),s("        this._marker = -1;"),s("        this._markerLine = this._markerColumn = 0;"),s("        this._backupCount = 0;"),s("        this._inputBuf = [];"),s("        this._line = this._tline = 0;"),s("        this._column = this._tcolumn = 0;"),s("        "),s("        this._lrState = [ 0 ];"),s("        this._sematicS = [];"),s("        this._sematicVal = null;"),s(""),s("        this._stop = false;"),s("    }"),s("    /**"),s("     *  set "),s("     */"),s("    private _setImg(s: string){"),s("        this._matched.length = 0;"),s("        for(let i = 0;i < s.length;i++){"),s("            this._matched.push(s.charAt(i));"),s("        }"),s("        this._tline = this._line;"),s("        this._tcolumn = this._column;"),s("    }"),s("    private _prepareToken(tid: number){"),s("        this._token = new Token("),s("            tid,"),s("            this._matched.join(''),"),s("            this._tline,"),s("            this._tcolumn,"),s("            this._line,"),s("            this._column"),s("        );"),s("        this._matched.length = 0;"),s("        this._tline = this._line;"),s("        this._tcolumn = this._column;"),s("    }"),s("    private _returnToken(){"),i("        this._emit('token', "),i(n),s("tokenNames[this._token.id], this._token.val);"),s("        while(!this._stop && !this._acceptToken(this._token));"),s("        this._token = null;"),s("    }"),s("    private _emit(name: string, a1?, a2?, a3?){"),s("        let cbs = this._handlers[name];"),s("        if(cbs){"),s("            for(let cb of cbs){"),s("                cb(a1, a2, a3);"),s("            }"),s("        }"),s("    }"),s("    on(name: string, cb: (a1?, a2?, a3?) => any){"),s("        this._handlers[name] || (this._handlers[name] = []);"),s("        this._handlers[name].push(cb);"),i("    }");for(f=0,p=t.dfas;f<p.length;f++)_(p[f],f);s(""),s("    /**"),s("     *  do a lexical action"),s("     *  @api private"),s("     *  @internal"),s("     */"),s("    private _doLexAction(lexstate: number, state: number){"),i("        switch(lexstate){");for(f=0;f<t.dfas.length;f++)s(""),i("            case "),i(f),s(":"),i("                this._doLexAction"),i(f),s("(state);"),i("                break;");s(""),s("            default:;"),s("        }"),s("        this._token !== null && this._returnToken();"),s("    }"),s("    /**"),s("     *  accept a character"),s("     *  @return - true if the character is consumed, false if not consumed"),s("     *  @api private"),s("     *  @internal"),s("     */"),s("    private _acceptChar(c: string){"),s("        let lexstate = this._lexState[this._lexState.length - 1];"),s("        let retn = { state: this._state, hasArc: false, isEnd: false };"),i("        "),i(n),s("lexers[lexstate](c.charCodeAt(0), retn);"),s("        if(retn.isEnd){"),s("            // if current state is a terminate state, be careful"),s("            if(retn.hasArc){"),s("                if(retn.state === -1){"),s("                    // nowhere to go, stay where we are"),s("                    this._doLexAction(lexstate, this._state);"),s("                    // recover"),s("                    this._marker = -1;"),s("                    this._backupCount = 0;"),s("                    this._state = 0;                    "),s("                    // character not consumed"),s("                    return false;"),s("                }"),s("                else {"),s("                    // now we can either go to that new state, or stay where we are"),s("                    // it is prefered to move forward, but that could lead to errors,"),s("                    // so we need to memorize this state before move on, in case if "),s("                    // an error occurs later, we could just return to this state."),s("                    this._marker = this._state;"),s("                    this._markerLine = this._line;"),s("                    this._markerColumn = this._column;"),s("                    this._state = retn.state;"),s("                    this._backupCount = 1;"),s("                    c === '\\n' ? (this._line++, this._column = 0) : (this._column++);"),s("                    this._matched.push(c);"),s("                    // character consumed"),s("                    return true;"),s("                }"),s("            }"),s("            else {"),s("                // current state doesn't lead to any state, just stay here."),s("                this._doLexAction(lexstate, this._state);"),s("                // recover"),s("                this._marker = -1;"),s("                this._backupCount = 0;"),s("                this._state = 0;"),s("                // character not consumed"),s("                return false;"),s("            }"),s("        }"),s("        else {"),s("            if(retn.state === -1){"),s("                // nowhere to go at current state, error may have occured."),s("                // check marker to verify that"),s("                if(this._marker !== -1){"),s("                    // we have a previously marked state, which is a terminate state."),s("                    // rollback"),s("                    this._state = this._marker;"),s("                    this._marker = -1;"),s("                    this._line = this._markerLine;"),s("                    this._column = this._markerColumn;"),s("                    while(this._backupCount --\x3e 0){"),s("                        this._inputBuf.push(this._matched.pop());"),s("                    }"),s("                    this._doLexAction(lexstate, this._state);"),s("                    this._state = 0;"),s("                    // character not consumed"),s("                    return false;"),s("                }"),s("                else {"),s("                    // error occurs"),s("                    this._emit('lexicalerror', `unexpected character \"${c}\"`);"),s("                    // force consume"),s("                    return true;"),s("                }"),s("            }"),s("            else {"),s("                this._state = retn.state;"),s("                c === '\\n' ? (this._line++, this._column = 0) : (this._column++);"),s("                this._matched.push(c);"),s("                // character consumed"),s("                return true;"),s("            }"),s("        }"),s("    }"),s("    private _acceptEOF(){"),s("        if(this._state === 0){"),s("            // recover"),s("            this._prepareToken(0);"),s("            this._returnToken();"),s("            return true;"),s("        }"),s("        else {"),s("            let lexstate = this._lexState[this._lexState.length - 1];"),s("            let retn = { state: this._state, hasArc: false, isEnd: false };"),i("            "),i(n),s("lexers[lexstate](-1, retn);"),s("            if(retn.isEnd){"),s("                this._doLexAction(lexstate, this._state);"),s("                this._state = 0;"),s("                this._marker = -1;"),s("                return false;"),s("            }"),s("            else if(this._marker !== -1){"),s("                this._state = this._marker;"),s("                this._marker = -1;"),s("                this._line = this._markerLine;"),s("                this._column = this._markerColumn;"),s("                while(this._backupCount --\x3e 0){"),s("                    this._inputBuf.push(this._matched.pop());"),s("                }"),s("                this._doLexAction(lexstate, this._state);"),s("                this._state = 0;"),s("                return false;"),s("            }"),s("            else {"),s("                this._emit('lexicalerror', 'unexpected end of file');"),s("                return true;"),s("            }"),s("        }"),s("    }"),s("    /**"),s("     *  input a string"),s("     *  @api public"),s("     */"),s("    accept(s: string){"),s("        if(!this._stop){"),s("            for(let i = s.length - 1; i >= 0; i--){"),s("                this._inputBuf.push(s.charAt(i));"),s("            }"),s("            while(!this._stop && this._inputBuf.length > 0){"),s("                this._acceptChar(this._inputBuf[this._inputBuf.length - 1]) && this._inputBuf.pop();"),s("            }"),s("        }"),s("    }"),s("    /**"),s("     *  tell the compiler that end of file is reached"),s("     *  @api public"),s("     */"),s("    end(){"),s("        while(!this._stop){"),s("            if(this._inputBuf.length > 0){"),s("                this._acceptChar(this._inputBuf[this._inputBuf.length - 1]) && this._inputBuf.pop();"),s("            }"),s("            else if(this._acceptEOF()){"),s("                break;"),s("            }"),s("        }"),s("        this._stop = true;"),s("    }"),s("    halt(){"),s("        this._stop = true;"),i("    }");s(""),i("    private _doReduction("),i(n),s("rulenum: number){"),i("        let "),i(n),i("nt = "),i(n),i("lhs["),i(n),s("rulenum];"),i("        let "),i(n),s("sp = this._sematicS.length;"),i("        let "),i(n),i("top = this._sematicS["),i(n),i("sp - "),i(n),i("ruleLen["),i(n),s("rulenum]] || null;"),i("        switch("),i(n),i("rulenum){"),function(){for(var e={addBlock:function(t,e){s(""),i("                {"),i(t.replace(/\$\$/g,n+"top")),i("}")},pushLexState:function(t){s(""),i("                this._lexState.push("),i(t),i(");")},popLexState:function(){s(""),i("                this._lexState.pop();")},setImg:function(t){s(""),i('                this._setImg("'),i(t),i('");')},returnToken:function(t){s(""),s("                this._token = {"),i("                    id: "),i(t.index),s(","),s("                    val: this._matched.join('')"),i("                };")}},r=0,o=t.g.rules;r<o.length;r++){var a=o[r];if(null!==a.action){s(""),i("            case "),i(a.index),s(":"),i("                /* "),i(a.toString()),i(" */");for(var h in a.vars)s(""),i("                var "),i(h),i(" = this._sematicS["),i(n),i("sp - "),i(a.rhs.length-a.vars[h].val),i("];");for(var u in a.usedVars)s(""),i("                var "),i(u),i(" = this._sematicS["),i(n),i("sp - "),i(a.usedVars[u].val),i("];");for(var l=0,c=a.action;l<c.length;l++)c[l].toCode(e);s(""),i("                break;")}}}(),s(""),s("        }"),i("        this._lrState.length -= "),i(n),i("ruleLen["),i(n),s("rulenum];"),i("        let "),i(n),s("cstate = this._lrState[this._lrState.length - 1];"),i("        this._lrState.push("),i(n),i("pgoto["),i(n),i("disgoto["),i(n),i("cstate] + "),i(n),s("nt]);"),s(""),i("        this._sematicS.length -= "),i(n),i("ruleLen["),i(n),s("rulenum];"),i("        this._sematicS.push("),i(n),s("top);"),s("    }"),s(""),s("    private _acceptToken(t: Token){"),s("        // look up action table"),s("        let cstate = this._lrState[this._lrState.length - 1];"),i("        let ind = "),i(n),s("disact[cstate] + t.id;"),s("        let act = 0;"),i("        if(ind < 0 || ind >= "),i(n),i("pact.length || "),i(n),s("checkact[ind] !== cstate){"),i("            act = -"),i(n),s("defred[cstate] - 1;"),s("        }"),s("        else {"),i("            act = "),i(n),s("pact[ind];"),s("        }"),i("        if(act === "),i(n),s("actERR){"),s("            // explicit error"),s("            this._syntaxError(t);"),s("            return true;"),s("        }"),s("        else if(act > 0){"),s("            // shift"),s("            if(t.id === 0){"),s("                // end of file"),s("                this._stop = true;"),s("                this._emit('accept');"),s("                return true;"),s("            }"),s("            else {"),s("                this._lrState.push(act - 1);"),s("                this._sematicS.push(this._sematicVal);"),s("                this._sematicVal = null;"),s("                // token consumed"),s("                return true;"),s("            }"),s("        }"),s("        else if(act < 0){"),s("            this._doReduction(-act - 1);"),s("            return false;"),s("        }"),s("        else {"),s("            // error"),s("            this._syntaxError(t);"),s("            // force consume"),s("            return true;"),s("        }"),s("    }"),s("    private _syntaxError(t: Token){"),s("        let msg = `unexpected token ${t.toString()}, expecting one of the following token(s):\\n`"),s("        msg += this._expected(this._lrState[this._lrState.length - 1]);"),s('        this._emit("syntaxerror", msg);'),s("    }"),s("    private _expected(state: number){"),i("        let dis = "),i(n),s("disact[state];"),s("        let ret = '';"),s("        function expect(tk: number){"),s("            let ind = dis + tk;"),i("            if(ind < 0 || ind >= "),i(n),i("pact.length || state !== "),i(n),s("checkact[ind]){"),i("                return "),i(n),s("defred[state] !== -1;"),s("            }"),s("            else {"),s("                return true;"),s("            }"),s("        }"),i("        for(let tk = 0; tk < "),i(n),s("tokenCount; tk++){"),s("            expect(tk) && (ret += `    ${tokenToString(tk)} ...` + '\\n');"),s("        }"),s("        return ret;"),s("    }"),i("}")}(t,e),e.save(".ts")},Tt["typescript"]=At;var At,bt=Object.freeze({compress:St,IntervalSet:f});t.Pattern=V,t.io=x,t.debug=bt,t.highlightUtil=ot,t.setDebugger=function(t){return o.log=t.log},t.setTab=function(t){return s=t},t.genResult=function(t){var e=new Et;try{var n=at(k(t),e)}catch(t){return e.terminated=!0,e.err(t),e}var r=n.grammar;e.file=n;for(var i=0,s=r.tokens;i<s.length;i++){var a=s[i];a.used||e.warn(new L("token <"+a.sym+"> is never used (defined at line "+a.line+")"))}for(var h=0,u=r.nts;h<u.length;h++){var l=u[h];l.used||e.warn(new L('non terminal "'+l.sym+'" is unreachable'))}if(e.hasError())return e.terminated=!0,e;r.genFirstSets();var c=gt(r);e.itemSets=c.result,e.iterationCount=c.iterations;var f=function(t,e){var n=[];function r(e,r,i){var s=t.tokens[r.getShift()];if(s.assoc!==G.UNDEFINED){var a=i.rule.pr;if(-1!==a){if(a>s.pr)return i;if(a<s.pr)return r;if(s.assoc===G.LEFT)return i;if(s.assoc===G.RIGHT)return r;if(s.assoc===G.NON)return lt.NULL;o.assert(!1)}}var h=new _t;return h.type=pt.SR,h.set=e,h.token=s,h.used=r,h.discarded=i,n.push(h),r}function i(e,r,i,s){var o=t.tokens[s];if(-1!==r.rule.pr&&-1!==i.rule.pr&&r.rule.pr!==i.rule.pr)return r.rule.pr>i.rule.pr?r:i;var a=r.rule.index>i.rule.index?i:r,h=r.rule.index>i.rule.index?r:i,u=new _t;return u.type=pt.RR,u.set=e,u.token=o,u.used=a,u.discarded=h,n.push(u),a}var s=new dt(t,e.size);return e.forEach(function(e){e.forEach(function(n){if(n.actionType===ht.SHIFT){var a=n.getShift();if(t.isToken(a)){var h=e.stateIndex*t.tokenCount+a;null!==(l=s.shift[h])?l.actionType===ht.REDUCE?s.shift[h]=r(e,n,l):o.assert(l.shift===n.shift):s.shift[h]=n}else h=e.stateIndex*t.nts.length+(-a-1),s.gotot[h]=n}else if(n.actionType===ht.REDUCE){for(var u=0;u<t.tokenCount;u++)if(n.lah.contains(u+1)){var l,c=e.stateIndex*t.tokenCount+u;null!==(l=s.shift[c])?l.actionType===ht.REDUCE?s.shift[c]=i(e,l,n,u):l.actionType===ht.SHIFT&&(s.shift[c]=r(e,l,n)):s.shift[c]=n}}else o.assert(!1)})}),{result:s,conflicts:n}}(r,e.itemSets);f.result.findDefAct(),e.parseTable=new xt(f.result);for(var p=0,d=f.conflicts;p<d.length;p++){var v=d[p];e.warn(new L(v.toString()))}return e},t.generateCode=function(t,e,n,r){if(void 0===Tt[t])throw'template for language "'+t+'" is not implemented yet';Tt[t](e,n)},Object.defineProperty(t,"__esModule",{value:!0})});
